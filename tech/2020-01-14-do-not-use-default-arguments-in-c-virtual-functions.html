<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Ashwin Nanjappa">
  <title>Code Yarns ‚Äì Do not use default arguments in C++ virtual functions</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="../styles.css">
  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" href="https://codeyarns.com/tech/rss.xml" />
  <!-- Microsoft Clarity Analytics -->
  <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "3wadqgw95m");
  </script>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143311697-1">
  </script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-143311697-1');
  </script>
  <!-- Google Adsense -->
  <script data-ad-client="ca-pub-1956250892185343" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js">
  </script>
  <!-- Twitter button -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</head>

<body>

<div class="contentbox">
<div class="header">
    <a href=".." class="header">Code Yarns ‚Äçüë®‚Äçüíª</a>
  </div>
  <div class="header">
    <a class="header2" href="https://codeyarns.com/tech/">Tech Blog</a> ‚ùñ <a class="header2" href="https://codeyarns.com/personal/">Personal Blog</a>
  </div>
  <div class="header" style="padding-top: 10px;">
    <iframe src="https://duckduckgo.com/search.html?site=codeyarns.com&kp=-2&kc=1&prefill=Search this website" style="width:300px;height:40px;" frameborder="0"></iframe>
</div>
</div>

<br />

<div class="contentbox">
<header>
<h1 class="title">Do not use default arguments in C++ virtual functions</h1>
<p class="date">üìÖ 2020-Jan-15 ‚¨© ‚úçÔ∏è Ashwin Nanjappa ‚¨© üè∑Ô∏è  ‚¨© üìö <a href="index.html">Archive</a></p>
</header>
<p>In an earlier post I described how <a href="2020-01-01-default-arguments-in-c.html"><strong>default arguments</strong></a> are implemented in C++. Essentially, default arguments do not exist in the function definition generated by the compiler. They are added by the compiler at the call site, at compile time. They are not set at run time. This should already tell you why using default arguments in virtual functions can be harmful.</p>
<p>Conside the situation where you have a base class pointer pointing to a derived class object. If you call a virtual function from the base class pointer, it will be redirected to the right derived class virtual function thanks to the use of virtual table. However, the default arguments for this call are set by the compiler at compile time. Since the compiler knows only that the pointer is of base class at compile time, it sets the default arguments from the base virtual function for this class. This is typically not the intended behavior by the author of the code.</p>
<p>Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span>

<span class="kw">struct</span> A
{
    <span class="kw">virtual</span> <span class="dt">void</span> foobar(<span class="dt">int</span> x = <span class="dv">10</span>) = <span class="dv">0</span>;
};

<span class="kw">struct</span> B : A
{
    <span class="dt">void</span> foobar(<span class="dt">int</span> x = <span class="dv">99</span>) <span class="kw">final</span>
    {
        <span class="bu">std::</span>cout &lt;&lt; <span class="st">&quot;B-&gt;foobar(&quot;</span> &lt;&lt; x &lt;&lt; <span class="st">&quot;)</span><span class="sc">\n</span><span class="st">&quot;</span>;
    }
};

<span class="dt">int</span> main()
{
    B* b = <span class="kw">new</span> B;
    A* a = b;

    b-&gt;foobar();
    a-&gt;foobar();

    <span class="cf">return</span> <span class="dv">0</span>;
}</code></pre></div>
<p>The author probably intended this program to print:</p>
<pre><code>B-&gt;foobar(99)
B-&gt;foobar(99)</code></pre>
<p>However, it actually prints:</p>
<pre><code>B-&gt;foobar(99)
B-&gt;foobar(10)</code></pre>
<p>We can verify that the compiler sets the default arguments at the call site at compile time by checking the assembly code:</p>
<pre><code># tmp.cpp:21:     b-&gt;foobar();
        movq    -32(%rbp), %rax # b, tmp94
        movl    $99, %esi       #, &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 99 as default argument
        movq    %rax, %rdi      # tmp94,
        call    _ZN1B6foobarEi  #
# tmp.cpp:22:     a-&gt;foobar();
        movq    -24(%rbp), %rax # a, tmp95
        movq    (%rax), %rax    # a_9-&gt;_vptr.A, _1
        movq    (%rax), %rax    # *_1, _2
        movq    -24(%rbp), %rdx # a, tmp96
        movl    $10, %esi       #, &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 10 as default argument
        movq    %rdx, %rdi      # tmp96,
        call    *%rax   # _2</code></pre>
</div>

<br />

<div class="contentbox">

<div class="footer"><a href="mailto:codeyarns@gmail.com" style="text-decoration: none; font-size: xx-large;">üìß</a> <a href="https://twitter.com/codeyarns" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @codeyarns</a> <a href="https://www.buymeacoffee.com/codeyarns"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" style="height: 38px !important;width: 163px !important;" ></a></div>
</div>

</body>
</html>
