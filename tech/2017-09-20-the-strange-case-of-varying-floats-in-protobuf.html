<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Ashwin Nanjappa">
  <title>Code Yarns â€“ The strange case of varying floats in Protobuf</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../styles.css">
  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" href="https://codeyarns.com/tech/rss.xml" />
</head>

<body>

<div class="contentbox">
<div class="header">
    <a href=".." class="header">Code Yarns â€ğŸ‘¨â€ğŸ’»</a>
</div>
<div class="header">
    <a class="header2" href="https://codeyarns.com/tech/">Tech Blog</a> â– <a class="header2" href="https://codeyarns.com/personal/">Personal Blog</a>
</div>
</div>

<br />

<div class="contentbox">
<header>
<h1 class="title">The strange case of varying floats in Protobuf</h1>
<p class="date">ğŸ“… 2017-Sep-20 â¬© âœï¸ Ashwin Nanjappa â¬© ğŸ·ï¸ <a href='index.html#float'>float</a>, <a href='index.html#protobuf'>protobuf</a> â¬© ğŸ“š <a href="index.html">Archive</a></p>
</header>
<h2 id="problem">Problem</h2>
<p>I was using <strong>Google Protobuf</strong> in a Python program to
read some text format Protobuf messages, merge them and write them out.
Surprisingly, for the same set of input text format message files, I was
getting different outputs on two computers! The values that were
different were float values. The float values were generally correct,
but varied slightly in precision between the two computers.</p>
<h2 id="solution">Solution</h2>
<p>This strange observation took quite a long investigation. I initially
assumed that maybe the Protobuf library (<code>libprotobuf.so</code>) or
the Python Protobuf package were of different versions on these two
computers. Surprisingly, they were exactly the same.</p>
<p>The mystery finally turned out to be the Protobuf
<strong>implementation type</strong>. There are currently two possible
types: <strong>cpp</strong> and <strong>python</strong>. By default, the
cpp implementation is used. However, on one of the computers, the python
implementation had been chosen by an engineer during the PIP package
installation. The way to pick the engine is by setting an environment
variable named <code>PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION</code> to
either <code>cpp</code> or <code>python</code>. The engineer had set
this environment variable in his shell when playing around with Protobuf
and had later installed the PIP package.</p>
<p>Once I explicitly set the
<code>PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION</code> environment variable
manually in my Python code before importing protobuf, the float values
were the same on both computers!</p>
<p>Now why should the engine affect the float value? Because Pythonâ€™s
float is actually double precision. On the other hand, when a 32-bit
float moved between Python code and the C++ engine and back to Python
code, it was sometimes changing precision. By using the same engine on
all computers, we ensured that at least the float values did not vary
between machines.</p>
<p><strong>Tried with:</strong> Python Protobuf 3.3.0 and Ubuntu
14.04</p>
</div>

<br />

<div class="contentbox">

<div style="text-align: center">
Â© 2026 Ashwin Nanjappa
â€¢
All writing under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a> license
â€¢
<a href="https://mastodon.social/@codeyarns">ğŸ˜ Mastodon</a>
â€¢
<a href="https://bsky.app/profile/codeyarns.bsky.social">ğŸ¦‹ Bluesky</a>
â€¢
<a href="mailto:codeyarns@gmail.com">ğŸ“§ Email</a>
</div>
</div>

</body>
</html>
