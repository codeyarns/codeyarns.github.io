<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Ashwin Nanjappa">
  <title>Code Yarns ‚Äì Aligned memory allocation</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../styles.css">
  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" href="https://codeyarns.com/tech/rss.xml" />
</head>

<body>

<div class="contentbox">
<!-- BEGIN before body -->

<!-- Website title -->
<div class="header">
    <a href=".." class="header">Code Yarns ‚Äçüë®‚Äçüíª</a>
</div>

<!-- Blog links -->
<div class="header">
    <a class="header2" href="https://codeyarns.com/tech/">Tech Blog</a> ‚ùñ <a class="header2" href="https://codeyarns.com/personal/">Personal Blog</a>
</div>

<!-- Search box -->
<br />
<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script>

<!-- END before body -->
</div>

<br />

<div class="contentbox">
<header>
<h1 class="title">Aligned memory allocation</h1>
<p class="date">üìÖ 2017-Feb-28 ‚¨© ‚úçÔ∏è Ashwin Nanjappa ‚¨© üè∑Ô∏è <a href='index.html#free'>free</a>, <a href='index.html#malloc'>malloc</a> ‚¨© üìö <a href="index.html">Archive</a></p>
</header>
<p>In some scenarios, we want the system to allocate memory for us that
is <strong>aligned</strong> at an address that is a certain power of 2.
Certain CPU architectures and certain operations require (or are faster)
if their operands are located at an address that is a multiple of a
certain power-of-2 number. For these reasons, you might see that many
multi-platform libraries use an aligned memory allocator instead of
<strong>malloc</strong> in their code. For example, OpenCV uses methods
named <strong>fastMalloc</strong> and <strong>fastFree</strong> inside
its code that do this type of allocation and freeing.</p>
<figure>
<img src="2017-02-28-aligned-memory-allocation.png"
alt="Example of aligned memory allocation" />
<figcaption aria-hidden="true">Example of aligned memory
allocation</figcaption>
</figure>
<p>Many of these methods work as follows:</p>
<ol type="1">
<li>User requests for <code>N</code> bytes of memory.</li>
<li>We ask <code>malloc</code> for <code>N + P + (A - 1)</code> bytes.
Here, <code>P</code> is the size of a pointer of that system and
<code>A</code> is the alignment required. <code>A</code> is a power-of-2
number. For example, if I request for 100 bytes on a 32-bit CPU and
require the memory to be aligned to a multiple of 8, then the wrapper
will request for 111 bytes.</li>
<li>After getting the memory from malloc, we align the pointer forward
so that (1) the pointer is at an address that is aligned as per
requirement and (2) there is space behind the pointer to store a memory
address. We return this pointer to the user.</li>
<li>We reach back <code>P</code> bytes behind the address we gave the
user and store the address we got from malloc there.</li>
<li>Once the user is done they call our version of free with the pointer
we had given them.</li>
<li>We reach behind this pointer by <code>P</code> bytes to get the
address we got from malloc.</li>
<li>We call <code>free</code> on that pointer to cleanly free all the
memory.</li>
</ol>
<p>Here is some example code that illustrates aligned memory
allocation:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Assume we need 32-byte alignment for AVX instructions</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ALIGN </span><span class="dv">32</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>aligned_malloc<span class="op">(</span><span class="dt">int</span> size<span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// We require whatever user asked for PLUS space for a pointer</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PLUS space to align pointer as per alignment requirement</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>mem <span class="op">=</span> malloc<span class="op">(</span>size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">void</span><span class="op">*)</span> <span class="op">+</span> <span class="op">(</span>ALIGN <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Location that we will return to user</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This has space *behind* it for a pointer and is aligned</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// as per requirement</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>ptr <span class="op">=</span> <span class="op">(</span><span class="dt">void</span><span class="op">**)((</span><span class="dt">uintptr_t</span><span class="op">)</span> <span class="op">(</span>mem <span class="op">+</span> <span class="op">(</span>ALIGN <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">void</span><span class="op">*))</span> <span class="op">&amp;</span> <span class="op">~(</span>ALIGN <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sneakily store address returned by malloc *behind* user pointer</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// void** cast is cause void* pointer cannot be decremented, cause</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// compiler has no idea &quot;how many&quot; bytes to decrement by</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">((</span><span class="dt">void</span> <span class="op">**)</span> ptr<span class="op">)[-</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> mem<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return user pointer</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ptr<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> aligned_free<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>ptr<span class="op">)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sneak *behind* user pointer to find address returned by malloc</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use that address to free</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(((</span><span class="dt">void</span><span class="op">**)</span> ptr<span class="op">)[-</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>

<br />

<div class="contentbox">

<div style="text-align: center">
¬© 2026 Ashwin Nanjappa
‚Ä¢
All writing under <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a> license
‚Ä¢
<a href="https://mastodon.social/@codeyarns">üêò Mastodon</a>
‚Ä¢
<a href="https://bsky.app/profile/codeyarns.bsky.social">ü¶ã Bluesky</a>
‚Ä¢
<a href="mailto:codeyarns@gmail.com">üìß Email</a>
</div>
</div>

</body>
</html>
