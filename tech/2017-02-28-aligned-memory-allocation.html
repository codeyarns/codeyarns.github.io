<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Ashwin Nanjappa">
  <title>Code Yarns ‚Äì Aligned memory allocation</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../styles.css">
  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" href="https://codeyarns.github.io/tech/rss.xml" />
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143311697-1">
  </script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-143311697-1');
  </script>
  <!-- Google Adsense -->
  <script data-ad-client="ca-pub-6045459060677327" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js">
  </script>
  <!-- Twitter button -->
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</head>
<body>
<table style="width: 100%;">
    <tr>
        <td style="text-align: left;">
            <a href=".." class="header">Code Yarns ‚Äçüë®‚Äçüíª</a>
        </td>
        <td style="text-align: right;">
            <div class="header2"><a class="header2" href="https://codeyarns.github.io/tech/">Tech Blog</a> ‚ùñ <a class="header2" href="https://codeyarns.github.io/personal/">Personal Blog</a></div>
            </br>
            <iframe src="https://duckduckgo.com/search.html?site=codeyarns.github.io&kp=-2&kc=1&prefill=Search this website" style="overflow:hidden;margin:0;padding:0;width:300px;height:40px;" frameborder="0"></iframe>
        </td>
    </tr>
</table>
<hr />
<header>
<h1 class="title">Aligned memory allocation</h1>
<p class="date">(First posted on: 2017-02-28 14:04:42+00:00)</p>
</header>
<p>In some scenarios, we want the system to allocate memory for us that is <strong>aligned</strong> at an address that is a certain power of 2. Certain CPU architectures and certain operations require (or are faster) if their operands are located at an address that is a multiple of a certain power-of-2 number. For these reasons, you might see that many multi-platform libraries use an aligned memory allocator instead of <strong>malloc</strong> in their code. For example, OpenCV uses methods named <strong>fastMalloc</strong> and <strong>fastFree</strong> inside its code that do this type of allocation and freeing.</p>
<p>Many of these methods work as follows:</p>
<ul>
<li>It internally gets memory from malloc. However, if you requested for <code>N</code> bytes, the wrapper will request for <code>N+P+A</code> bytes from malloc. Here, <code>P</code> is the size of a pointer on that CPU architecture and <code>A</code> is the alignment required, expressed in power-of-2 number of bytes. For example, if I request for 100 bytes on a 64-bit CPU and require the memory to be aligned to a multiple of 32, then the wrapper will request for 140 bytes.</li>
<li>After getting the memory from malloc, it aligns the pointer forward so that (1) the pointer is at an address that is aligned as per requirement and (2) there is space behind the pointer to store a memory address.</li>
<li>Then it sneaks and store the address actually returned by malloc behind the pointer address and returns the forward-aligned pointer to the user.</li>
<li>After the user is done with the memory, they call the custom free method. This free wrapper then sneaks behind the aligned pointer to get the actual address returned by malloc and free that.</li>
</ul>
<p>Here is some example code that illustrates aligned memory allocation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// Assume we need 32-byte alignment for AVX instructions</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="pp">#define ALIGN </span><span class="dv">32</span></a>
<a class="sourceLine" id="cb1-3" title="3"></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="dt">void</span> *aligned_malloc(<span class="dt">int</span> size)</a>
<a class="sourceLine" id="cb1-5" title="5">{</a>
<a class="sourceLine" id="cb1-6" title="6">    <span class="co">// We require whatever user asked for PLUS space for a pointer</span></a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="co">// PLUS space to align pointer as per alignment requirement</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="dt">void</span> *mem = malloc(size + <span class="kw">sizeof</span>(<span class="dt">void</span>*) + (ALIGN - <span class="dv">1</span>));</a>
<a class="sourceLine" id="cb1-9" title="9">    </a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="co">// Location that we will return to user</span></a>
<a class="sourceLine" id="cb1-11" title="11">    <span class="co">// This has space *behind* it for a pointer and is aligned</span></a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="co">// as per requirement</span></a>
<a class="sourceLine" id="cb1-13" title="13">    <span class="dt">void</span> *ptr = (<span class="dt">void</span>**)((<span class="dt">uintptr_t</span>) (mem + (ALIGN - <span class="dv">1</span>) + <span class="kw">sizeof</span>(<span class="dt">void</span>*)) &amp; ~(ALIGN - <span class="dv">1</span>));</a>
<a class="sourceLine" id="cb1-14" title="14">    </a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="co">// Sneakily store address returned by malloc *behind* user pointer</span></a>
<a class="sourceLine" id="cb1-16" title="16">    <span class="co">// void** cast is cause void* pointer cannot be decremented, cause</span></a>
<a class="sourceLine" id="cb1-17" title="17">    <span class="co">// compiler has no idea &quot;how many&quot; bytes to decrement by</span></a>
<a class="sourceLine" id="cb1-18" title="18">    ((<span class="dt">void</span> **) ptr)[-<span class="dv">1</span>] = mem;</a>
<a class="sourceLine" id="cb1-19" title="19">    </a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="co">// Return user pointer</span></a>
<a class="sourceLine" id="cb1-21" title="21">    <span class="cf">return</span> ptr;</a>
<a class="sourceLine" id="cb1-22" title="22">}</a>
<a class="sourceLine" id="cb1-23" title="23"></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="dt">void</span> aligned_free(<span class="dt">void</span> *ptr)</a>
<a class="sourceLine" id="cb1-25" title="25">{</a>
<a class="sourceLine" id="cb1-26" title="26">    <span class="co">// Sneak *behind* user pointer to find address returned by malloc</span></a>
<a class="sourceLine" id="cb1-27" title="27">    <span class="co">// Use that address to free</span></a>
<a class="sourceLine" id="cb1-28" title="28">    free(((<span class="dt">void</span>**) ptr)[-<span class="dv">1</span>]);</a>
<a class="sourceLine" id="cb1-29" title="29">}</a></code></pre></div>
<hr />
<div class="footer">
<a href="mailto:codeyarns@gmail.com" style="text-decoration: none; font-size: xx-large;">üìß</a> <a href="https://twitter.com/codeyarns" class="twitter-follow-button" data-show-count="false" data-size="large">Follow <span class="citation" data-cites="codeyarns">@codeyarns</span></a> <a href="https://www.buymeacoffee.com/codeyarns"><img src="https://cdn.buymeacoffee.com/buttons/default-orange.png" alt="Buy Me A Coffee" style="height: 38px !important;width: 163px !important;" ></a>
</div>
</body>
</html>
