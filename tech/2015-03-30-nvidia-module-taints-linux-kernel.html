<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Ashwin Nanjappa">
  <title>Code Yarns â€“ NVIDIA module taints Linux kernel</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="../styles.css">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143311697-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-143311697-1');
  </script>
</head>
<body>
<a href="..">Code Yarns</a> / <a href="index.html">Tech Blog</a> / Search my site <script async src="https://cse.google.com/cse.js?cx=003521915278168649297:cryrlg7hahe"></script>
<div class="gcse-search"></div>
<hr />
<header>
<h1 class="title">NVIDIA module taints Linux kernel</h1>
<p class="date">2015-03-30 12:58:50+00:00</p>
</header>
<h2 id="problem">Problem</h2>
<p>I installed CUDA 7.0 on Ubuntu running on an Aftershock notebook with NVIDIA graphics card. The NVIDIA graphics drivers were upgraded to version 346. To my pleasant surprise, the graphics card was now directly visible to the Linux kernel. There was no longer any need to use Bumblebee.</p>
<p>However, I started noticing that this Ubuntu would not always boot into Unity. On many cold starts, I saw that Ubuntu would show this error:</p>
<p>https://gist.github.com/ashwin/dce9fbbc0ae11380ff9b</p>
<p>After displaying this it would get stuck at the Ubuntu bootup screen.</p>
<p>I also noticed that I could boot up if I first booted into another Ubuntu instance I had on this notebook and later restarted and booted into the current Ubuntu instance.</p>
<h2 id="solution">Solution</h2>
<p><strong>Update:</strong> I no longer have this problem after installing <strong>CUDA 7.5</strong> and the <strong>NVIDIA 352</strong> drivers that come along with it on a fresh <strong>Ubuntu 15.04</strong> system. I still see the syslog errors, but they no longer stop Ubuntu from booting successfully and the GPU/CUDA can be used without problems. Yay! ðŸ˜„</p>
<p><strong>Old stuff:</strong></p>
<p>To analyse this problem I cropped out the relevant portions of <code>/var/log/syslog</code> for the case when Ubuntu booted correctly and when it threw the above kernel panic error. These syslog entries can be seen <a href="https://gist.github.com/ashwin/2a449e05aa7663e795e4">here</a>.</p>
<p>What I found was that there was some kind of a race condition at boot time. If the <code>nvidia-drm</code> module registered early enough with the kernel, then everything was fine. Otherwise, the kernel would complain that the NVIDIA module was <strong>tainting</strong> it and then it would throw up the above error.</p>
<p>The problem seems to lie in the Read-Copy-Update mechanism of the kernel. Here, some optimizations seem to have been added in recent versions to improve energy efficiency. RCU wakes up the CPUs only after a period of <code>RCU_IDLE_GP_DELAY</code> jiffies, as explained <a href="http://cateee.net/lkddb/web-lkddb/RCU_FAST_NO_HZ.html">here</a>. This is set to 4 by default, as seen <a href="http://lxr.free-electrons.com/source/kernel/rcu/tree_plugin.h#L1571">here</a>.</p>
<p>The solution going around the web for this problem is to decrease this sleep time to 1 jiffy, so that the race condition can be ameliorated. Thankfully, we do not need to edit Linux kernel code and recompile to do this! A syslog entry <code>rcu_idle_gp_delay</code> was added for runtime manipulation, as explained <a href="https://lkml.org/lkml/2013/3/18/840">here</a>. If we set this to 1, then the chance of this error reduces a lot.</p>
<p>To do this, add the following line to <code>/etc/default/grub</code>:</p>
<pre><code>GRUB_CMDLINE_LINUX=&quot;rcutree.rcu_idle_gp_delay=1&quot;</code></pre>
<p>And run <code>update-grub</code> after this. Hopefully, this should fix the race condition so that every boot is successful.</p>
<p><strong>Related links</strong>:</p>
<ul>
<li><p>https://bbs.archlinux.org/viewtopic.php?id=192466</p></li>
<li><p>https://answers.launchpad.net/ubuntu/+source/nvidia-graphics-drivers-346/+question/262833</p></li>
<li><p>https://forums.gentoo.org/viewtopic-p-7597808.html</p></li>
<li><p>https://wiki.archlinux.org/index.php/NVIDIA_Optimus</p></li>
<li><p>https://wiki.archlinux.org/index.php/Bumblebee</p></li>
</ul>
<p><strong>Tried with:</strong> NVIDIA GTX 765M, Linux 3.13.0-44-generic and Ubuntu 14.04</p>
<hr />
<p><a href="rss.xml">RSS</a> - <a href="mailto:codeyarns@gmail.com">Contact</a></p>
</body>
</html>
